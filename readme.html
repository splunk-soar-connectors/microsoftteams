<!-- File: readme.html
  Copyright (c) 2019-2023 Splunk Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under
the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
either express or implied. See the License for the specific language governing permissions
and limitations under the License.
-->

<html>
<head></head>
<body>
<h2>Note</h2>
<ul>
    <li>For an admin user, you can run the test connectivity directly.
    <li>For a non-admin user, you need to get the admin consent first. This can be done by running the action <b>get_admin_consent</b> by an admin user.
</ul>
<h2>Authentication</h2>
This app requires creating an app in the Azure Active Directory.
<ul>
    <li>Navigate to the <a href="https://portal.azure.com" target="_blank">https://portal.azure.com</a> in a browser and log in with a Microsoft account</li>
    <li>Select <b>Azure Active Directory</b> from the left side menu</li>
    <li>From the left panel, select <b>App Registrations</b></li>
    <li>At the top of the middle section, select <b>New registration</b></li>
    <li>On the next page, give a name to your application and click <b>Register</b></li>
    <li>Once the app is created, the below steps needs to be performed on the next page:</li>
    <ul>
        <li>Under <b>Certificates & secrets</b>, select <b>New client secret</b>. Note this key somewhere secure, as it cannot be retrieved after closing the window.</li>
        <li>Under <b>Authentication</b>, select <b>Add a platform</b>. In the <b>Add a platform</b> window, select <b>Web</b>. The <b>Redirect
            URLs</b> should be filled right here. We will get <b>Redirect URLs</b> from the Phantom asset that we will create below in the section titled "Configure the Microsoft Teams Phantom app asset".</li>
        <li>Under <b>API Permissions</b>, the following minimum<b>Delegated Permissions</b> from <b>Microsoft Graph</b> needs to be added:
        <ul>
            <li><b>OnlineMeetings.ReadWrite</b> <u>(https://graph.microsoft.com/OnlineMeetings.ReadWrite)</u>: Allows an app to create, read online meetings on behalf of the signed-in user.</li>
            <li><b>Calendars.ReadWrite</b>  <u>(https://graph.microsoft.com/Calendars.ReadWrite)</u>: Allows the app to create, read, update, and delete events in user calendars.</li>
            <li><b>offline_access</b> <u>(https://graph.microsoft.com/offline_access)</u>: Allows the app to read and update user data, even when they are not currently using the app.</li>
            <li><b>Channel.ReadBasic.All</b>  <u>(https://graph.microsoft.com/Channel.ReadBasic.All)</u>: Read channel names and channel descriptions, on behalf of the signed-in user.</li>
            <li><b>User.ReadBasic.All</b> <u>(https://graph.microsoft.com/User.ReadBasic.All)</u>: Allows the app to read a basic set of profile properties of other users in your organization on behalf of the signed-in user. This includes display name, first and last name, email address, open extensions and photo. Also allows the app to read the full profile of the signed-in user.</li>
            <li><b>ChannelMessage.Send</b>  <u>(https://graph.microsoft.com/ChannelMessage.Send)</u>: Allows an app to send channel messages in Microsoft Teams, on behalf of the signed-in user.</li>
        </ul>
        After making these changes, click <b>Add permissions</b> at the bottom of the screen, then click <b>Grant admin consent for Phantom</b>.

        For revoking the permissions, please refer <a href="https://learn.microsoft.com/en-gb/azure/active-directory/manage-apps/manage-application-permissions?pivots=ms-graph" target="_blank">this</a> documentation.
    </ul>
</ul>

<h2>State file permissions</h2>
<p>
    Please check the permissions for the state file as mentioned below.
    <h4>State file path</h4>
    <ul>
        <li>For Non-NRI instance: /opt/phantom/local_data/app_states/&lt;appid&gt;/&lt;asset_id&gt;_state.json</li>
        <li>For NRI instance: /&lt;PHANTOM_HOME_DIRECTORY&gt;/local_data/app_states/&lt;appid&gt;/&lt;asset_id&gt;_state.json</li>
    </ul>
    <h4>State file permissions</h4>
    <ul>
        <li>File rights: rw-rw-r-- (664) (The phantom user should have read and write access for the state file)</li>
        <li>File owner: Appropriate phantom user</li>
    </ul>
</p>

<h2>Configure the Microsoft Teams Phantom app asset</h2>
When creating an asset for the <b>Microsoft Teams</b> app, place the <b>Application Id</b> of the app in the <b>Client ID</b> field and place the password generated during the app creation process in the <b>Client Secret</b> field. Then, after filling out the <b>Tenant ID</b> field, click <b>SAVE</b>. Both the Application/Client ID and the Tenant ID can be found in the <b>Overview</b> tab on your app's Azure page.
<br><br>
After saving, a new field will appear in the <b>Asset Settings</b> tab. Take the URL found in the <b>POST incoming for Microsoft Teams to this location</b> field and place it in the <b>Redirect URLs</b> field mentioned in a previous step. To this URL, add <b>/result</b>. After doing so the URL should look something like:
<br><br>
<p>
https://&lt;phantom_host&gt;/rest/handler/microsoftteams_6ba1906f-5899-44df-bb65-1bee4df8ca3c/&lt;asset_name&gt;/result
</p>
<br>
Once again, click Save at the bottom of the screen.
<br><br>
Additionally, updating the Base URL in the Phantom Company Settings is also required. Navigate to <b>Administration > Company Settings > Info</b> to configure the Base URL For Phantom Appliance. Then, select <b>Save Changes.</b>
<br>
<h2>Method to run get admin consent</h2>
Run <b>get_admin_consent</b> action. It will display an URL. Navigate to this URL in a separate browser tab. This new tab will redirect to a Microsoft login page. Log in to a Microsoft account with administrator privileges. After logging in, review the requested permissions listed, then click <b>Accept</b>. Finally, close that tab. Action should show a success message.
<p>
    <b>Note:</b> If the URL is not displayed while running the <b>get_admin_consent</b> action, the user can get the URL from the following ways:
    <ul>
        <li>User can find the URL in 'spawn.log' file.</li>
        <li>User needs to manually navigate to the URL in a separate browser tab. The URL format is:
        <b>https://&lt;phantom_host&gt;/rest/handler/microsoftteams_6ba1906f-5899-44df-bb65-1bee4df8ca3c/&lt;asset_name&gt;/admin_consent?asset_id=&lt;asset_id&gt;</b></li>
        <p><b>Steps to fetch asset id</b></p>
        <ul>
            <li>Open the asset on which the action is executed.</li>
            <li>URL for the asset will be in the following format:</li>
                <p><b>https//&lt;phantom_host&gt;/apps/&lt;app_id&gt;/asset/&lt;asset_id&gt;/</b></p>
            <li>Take the asset id from the URL.</li>
        </ul>
    </ul>
</p>

<h2>Method to run test connectivity</h2>
After setting up the asset and user, click the <b>TEST CONNECTIVITY</b> button. A window should pop up and display a URL. Navigate to this URL in a separate browser tab. This new tab will redirect to a Microsoft login page. Log in to a Microsoft account. After logging in, review the requested permissions listed, then click <b>Accept</b>. Finally, close that tab. The test connectivity window should show a success message.
<br><br>
The app should now be ready to be used.

<h2>Important points to be considered for 'Create Meeting' action</h2>
<ul>
  <li>The <b>timezone</b> configuration parameter will only be used for <b>Create Meeting</b> action, when the user wants to provide <b>start_time</b> and <b>end_time</b> of the meeting.</li>
  <li>The <b>timezone</b> parameter can be configured using the timezone of the microsoft teams calender. If not provided, by default the <b>UTC</b> timezone will be considered for scheduling the meetings.</li>
  <li>In case of add_calendar_event = true, if the user wants to provide schedule time for the meeting, <b>start_time</b> and <b>end_time</b> both the parameters are required.</li>
</ul>

<h2>Port Information</h2>
  <p>
    The app uses HTTP/HTTPS protocol for communicating with the Microsoft Teams Server. Below are the default ports used by Splunk SOAR.
    <table>
      <tr class=plain>
        <th>Service Name</th>
        <th>Transport Protocol</th>
        <th>Port</th>
      </tr>
      <tr>
        <td>http</td>
        <td>tcp</td>
        <td>80</td>
      </tr>
      <tr>
        <td>https</td>
        <td>tcp</td>
        <td>443</td>
      </tr>
    </table>
  </p>
</body>
</html>
